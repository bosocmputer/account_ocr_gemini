# PDF Support Documentation

## ğŸ“‹ Overview

à¹‚à¸›à¸£à¹€à¸ˆà¸„à¸™à¸µà¹‰à¹„à¸”à¹‰à¸£à¸­à¸‡à¸£à¸±à¸šà¸à¸²à¸£à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¹„à¸Ÿà¸¥à¹Œ PDF à¹à¸¥à¹‰à¸§ à¹‚à¸”à¸¢à¹ƒà¸Šà¹‰ **Gemini PDF Direct Support** à¸‹à¸¶à¹ˆà¸‡à¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¹ˆà¸‡ PDF à¹„à¸›à¸¢à¸±à¸‡ Gemini AI à¹‚à¸”à¸¢à¸•à¸£à¸‡à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™à¸£à¸¹à¸›à¸ à¸²à¸

## âœ¨ Features

- âœ… à¸£à¸­à¸‡à¸£à¸±à¸š PDF à¹à¸¥à¸° Image (JPG, PNG) à¹ƒà¸™à¸„à¸³à¸‚à¸­à¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸™
- âœ… à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸š file type à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸ˆà¸²à¸ Content-Type header
- âœ… à¸ªà¹ˆà¸‡ PDF à¹„à¸›à¸¢à¸±à¸‡ Gemini API à¹‚à¸”à¸¢à¸•à¸£à¸‡ (MIME type: `application/pdf`)
- âœ… à¸£à¸±à¸à¸©à¸² extension à¸‚à¸­à¸‡à¹„à¸Ÿà¸¥à¹Œà¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸—à¸ˆà¸£à¸´à¸‡
- âœ… à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£ preprocess PDF (à¸ªà¹ˆà¸‡à¹„à¸Ÿà¸¥à¹Œà¸”à¸´à¸š)

## ğŸ”§ à¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¸—à¸µà¹ˆà¸—à¸³

### 1. **handlers.go** - Download à¹à¸¥à¸° File Detection
- âœï¸ à¹à¸à¹‰à¹„à¸‚ `downloadImageFromURL()` à¹ƒà¸«à¹‰ return file extension à¸—à¸µà¹ˆà¸•à¸£à¸§à¸ˆà¸à¸š
- âœï¸ à¹€à¸à¸´à¹ˆà¸¡à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸š `application/pdf` à¸ˆà¸²à¸ Content-Type
- âœï¸ à¹à¸à¹‰à¹„à¸‚ filename generation à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰ extension à¸ˆà¸£à¸´à¸‡à¹à¸—à¸™ hardcode `.jpg`
- âœï¸ à¹€à¸à¸´à¹ˆà¸¡ logging à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸ªà¸”à¸‡à¸›à¸£à¸°à¹€à¸ à¸—à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”

**à¸ªà¸£à¸¸à¸›à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™:**
```
URL â†’ Download â†’ à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸š Content-Type â†’ à¸•à¸±à¹‰à¸‡à¸Šà¸·à¹ˆà¸­à¹„à¸Ÿà¸¥à¹Œà¸”à¹‰à¸§à¸¢ extension à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
```

### 2. **imageprocessor.go** - PDF Preprocessing Skip
- âœï¸ à¹à¸à¹‰à¹„à¸‚ `PreprocessImageHighQuality()` à¹ƒà¸«à¹‰à¹€à¸Šà¹‡à¸„ file extension à¸à¹ˆà¸­à¸™
- âœï¸ à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™ `.pdf` â†’ Skip preprocessing à¹à¸¥à¸° return raw PDF bytes à¸à¸£à¹‰à¸­à¸¡ MIME type `application/pdf`
- âœï¸ à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™à¸£à¸¹à¸›à¸ à¸²à¸ â†’ à¸—à¸³ preprocessing à¸•à¸²à¸¡à¸›à¸à¸•à¸´

**à¸ªà¸£à¸¸à¸›à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™:**
```
PDF â†’ Skip preprocessing â†’ Return raw bytes
Image â†’ Preprocess (enhance quality) â†’ Return processed bytes
```

### 3. **gemini.go** - Gemini API Integration
- âœï¸ à¹à¸à¹‰à¹„à¸‚ `ProcessPureOCR()` à¸£à¸­à¸‡à¸£à¸±à¸š MIME type `application/pdf`
- âœï¸ à¹à¸à¹‰à¹„à¸‚ fallback error handling à¹ƒà¸«à¹‰à¸£à¸­à¸‡à¸£à¸±à¸š PDF
- âœï¸ à¸›à¸£à¸±à¸š logging messages à¹ƒà¸«à¹‰à¹à¸ªà¸”à¸‡ "PDF" à¸«à¸£à¸·à¸­ "Image" à¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸—à¹„à¸Ÿà¸¥à¹Œ

**à¸ªà¸£à¸¸à¸›à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™:**
```
PDF â†’ Gemini API (with MIME: application/pdf) â†’ OCR text extraction
Image â†’ Gemini API (with MIME: image/jpeg|png) â†’ OCR text extraction
```

## ğŸ“Š Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client Request                                              â”‚
â”‚ POST /api/v1/analyze-receipt                                â”‚
â”‚ {                                                           â”‚
â”‚   "shopid": "xxx",                                          â”‚
â”‚   "imagereferences": [{                                     â”‚
â”‚     "imageuri": "https://.../file.pdf"  â† PDF URL          â”‚
â”‚   }]                                                        â”‚
â”‚ }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Download File                                       â”‚
â”‚ - GET request to Azure Blob                                 â”‚
â”‚ - Check Content-Type: application/pdf                       â”‚
â”‚ - Save as: {uuid}_0.pdf                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: Preprocess Check                                    â”‚
â”‚ - Detect extension: .pdf                                    â”‚
â”‚ - Skip image preprocessing                                  â”‚
â”‚ - Return: (raw_pdf_bytes, "application/pdf")               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: Send to Gemini API                                  â”‚
â”‚ - MIME Type: application/pdf                                â”‚
â”‚ - Data: raw PDF bytes                                       â”‚
â”‚ - Gemini extracts text from PDF                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: Process OCR Result                                  â”‚
â”‚ - Extract raw document text                                 â”‚
â”‚ - Continue with normal accounting analysis                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response: Accounting Entry + Receipt Data                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§ª à¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸š

### à¸§à¸´à¸˜à¸µà¸—à¸µà¹ˆ 1: à¹ƒà¸Šà¹‰ Test Script (à¹à¸™à¸°à¸™à¸³)

```bash
# 1. Start server
go run cmd/api/main.go

# 2. Run test script (in another terminal)
./test_pdf_support.sh
```

### à¸§à¸´à¸˜à¸µà¸—à¸µà¹ˆ 2: à¹ƒà¸Šà¹‰ curl à¹‚à¸”à¸¢à¸•à¸£à¸‡

```bash
curl -X POST http://localhost:8080/api/v1/analyze-receipt \
  -H "Content-Type: application/json" \
  -d '{
    "shopid": "2V5zu2gmRgd7sgWj3g6gu7mxYk0",
    "imagereferences": [
        {
            "documentimageguid": "36xoW2CODcX4lwItEfZFTsIcDdp",
            "imageuri": "https://dedeposblosstorage.blob.core.windows.net/dedeposdevcontainer/2V5zu2gmRgd7sgWj3g6gu7mxYk0/36xoVoP2BMAiIkYNbCqzLWf3evP.pdf"
        }
    ]
}'
```

### Expected Output

```json
{
  "status": "success",
  "receipt": {
    "vendor_name": "à¸šà¸£à¸´à¸©à¸±à¸— ABC à¸ˆà¸³à¸à¸±à¸”",
    "date": "2024-01-15",
    "total": 1500.00
  },
  "accounting_entry": {
    "entries": [...]
  },
  "validation": {
    "confidence": {
      "level": "high",
      "score": 92.5
    }
  },
  "metadata": {
    "request_id": "req-xxx",
    "duration_sec": 8.5,
    "token_usage": {...}
  }
}
```

## âš ï¸ à¸‚à¹‰à¸­à¸ˆà¸³à¸à¸±à¸”à¹à¸¥à¸°à¸„à¸³à¹à¸™à¸°à¸™à¸³

### à¸‚à¹‰à¸­à¸ˆà¸³à¸à¸±à¸”
1. **PDF Size Limit**: Gemini à¸¡à¸µà¸‚à¹‰à¸­à¸ˆà¸³à¸à¸±à¸”à¸‚à¸™à¸²à¸”à¹„à¸Ÿà¸¥à¹Œ (~20MB)
2. **Token Limit**: PDF à¸—à¸µà¹ˆà¸¡à¸µà¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¸¡à¸²à¸à¸­à¸²à¸ˆà¹€à¸à¸´à¸™ output token limit (8192 tokens)
3. **Multi-page PDFs**: à¸•à¸­à¸™à¸™à¸µà¹‰à¸ªà¹ˆà¸‡à¸—à¸±à¹‰à¸‡ PDF à¹„à¸› - Gemini à¸ˆà¸°à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸—à¸¸à¸à¸«à¸™à¹‰à¸²

### à¸„à¸³à¹à¸™à¸°à¸™à¸³
1. **PDF à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡**: à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆ 1-2 à¸«à¸™à¹‰à¸² à¸‚à¸™à¸²à¸”à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 5MB
2. **PDF Quality**: PDF à¸—à¸µà¹ˆà¸¡à¸µ text layer à¸ˆà¸°à¹„à¸”à¹‰à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¹à¸¡à¹ˆà¸™à¸¢à¸³à¸à¸§à¹ˆà¸² scanned PDF
3. **Error Handling**: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š `metadata.ocr_warnings` à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¸›à¸±à¸à¸«à¸² (à¸–à¹‰à¸²à¸¡à¸µ)

## ğŸ”® à¸­à¸™à¸²à¸„à¸• (Future Enhancements)

### Phase 2: PDF to Image Fallback
à¸–à¹‰à¸² Gemini PDF direct à¹„à¸¡à¹ˆà¸—à¸³à¸‡à¸²à¸™à¹„à¸”à¹‰à¸”à¸µ à¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸à¸´à¹ˆà¸¡ fallback:

```
PDF â†’ à¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™ images â†’ à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¹à¸šà¸š multi-image
```

**à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™:**
1. à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ PDF library: `go get github.com/pdfcpu/pdfcpu`
2. à¹à¸›à¸¥à¸‡ PDF pages à¹€à¸›à¹‡à¸™ images
3. à¸ªà¹ˆà¸‡à¹€à¸‚à¹‰à¸² OCR pipeline à¸›à¸à¸•à¸´

### Phase 3: Smart PDF Processing
- à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¸§à¹ˆà¸² PDF à¸¡à¸µ text layer à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
- à¸–à¹‰à¸²à¸¡à¸µ â†’ Extract text directly (à¹€à¸£à¹‡à¸§à¸à¸§à¹ˆà¸² OCR)
- à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ â†’ à¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™à¸£à¸¹à¸›à¸ à¸²à¸à¸à¹ˆà¸­à¸™ OCR

## ğŸ“š à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡

- [Gemini API - Supported File Types](https://ai.google.dev/gemini-api/docs/vision#supported-file-formats)
- Gemini à¸£à¸­à¸‡à¸£à¸±à¸š PDF à¹‚à¸”à¸¢à¸•à¸£à¸‡: `application/pdf`
- Max file size: ~20MB
- Best practices: Use PDF with text layer for better accuracy

## âœ… Checklist à¸ªà¸³à¸«à¸£à¸±à¸š Production

- [x] à¸£à¸­à¸‡à¸£à¸±à¸š PDF download à¹à¸¥à¸° detection
- [x] à¸ªà¹ˆà¸‡ PDF à¹„à¸›à¸¢à¸±à¸‡ Gemini API
- [x] Handle errors à¸ªà¸³à¸«à¸£à¸±à¸š PDF
- [ ] à¸—à¸”à¸ªà¸­à¸šà¸à¸±à¸š PDF à¸«à¸¥à¸²à¸¢à¸›à¸£à¸°à¹€à¸ à¸— (text layer, scanned, multi-page)
- [ ] à¹€à¸à¸´à¹ˆà¸¡ PDF size validation
- [ ] à¹€à¸à¸´à¹ˆà¸¡ PDF to Image fallback (optional)
- [ ] Monitor token usage à¸ªà¸³à¸«à¸£à¸±à¸š PDF (may use more tokens)
- [ ] Update API documentation

## ğŸ‰ à¸ªà¸£à¸¸à¸›

à¹‚à¸›à¸£à¹€à¸ˆà¸„à¸ªà¸²à¸¡à¸²à¸£à¸–à¸£à¸­à¸‡à¸£à¸±à¸š PDF à¹à¸¥à¹‰à¸§! à¸£à¸°à¸šà¸šà¸ˆà¸°:
1. à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸” PDF à¸ˆà¸²à¸ Azure Blob
2. à¸ªà¹ˆà¸‡ PDF à¹„à¸›à¸¢à¸±à¸‡ Gemini API à¹‚à¸”à¸¢à¸•à¸£à¸‡
3. Extract text à¹à¸¥à¸° process à¸•à¸²à¸¡à¸›à¸à¸•à¸´

**à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹à¸›à¸¥à¸‡ PDF à¹€à¸›à¹‡à¸™à¸£à¸¹à¸›à¸ à¸²à¸ - Gemini à¸—à¸³à¹„à¸”à¹‰à¹€à¸¥à¸¢!** ğŸš€
